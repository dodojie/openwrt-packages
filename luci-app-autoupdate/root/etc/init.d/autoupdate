#!/bin/bash /etc/rc.common
START=99
export Script=/bin/AutoUpdate.sh
export Corn_Task="bash ${Script} -u"

AutoUpdate_Service() {
	local Enable Enable_Proxy Force_Write Week Minute Hour Github
	[[ ! -f ${Script} ]] && exit 1
	Enable=$(uci_get autoupdate common enable)
	if [[ ${Enable} == 1 ]]; then
		Enable_Proxy=$(uci_get autoupdate common enable_proxy)
		Force_Write=$(uci_get autoupdate common force_write)
		Week=$(uci_get autoupdate common week)
		Minute=$(uci_get autoupdate common minute)
		Hour=$(uci_get autoupdate common hour)
		[[ ${Week} == 7 ]] && week="*"
		corn_rm
		[[ ${Enable_Proxy} == 1 ]] && Corn_Task="${Corn_Task} -P"
		[[ ${Force_Write} == 1 ]] && Corn_Task="${Corn_Task} -F"
		echo "Corn: [${Minute} ${Hour} * * ${Week} ${Corn_Task}]"
		echo -e "${Minute} ${Hour} * * ${Week} ${Corn_Task}		#AutoUpdate_CornTask" >> /etc/crontabs/root
		/etc/init.d/cron restart
	else
		uci_set autoupdate common force_write 0
		uci_set autoupdate common enable_proxy 0
		corn_rm
	fi
	Github=$(uci_get autoupdate common github)
	echo "Github: ${Github}"
	bash ${Script} -C ${Github} > /dev/null 2>&1
	exit 0
}

corn_rm() {
	[[ $(cat /etc/crontabs/root) =~ "#AutoUpdate_CornTask" ]] && {
		echo "Removing corn task ..."
		sed -i "/#AutoUpdate_CornTask/d" /etc/crontabs/root
		/etc/init.d/cron restart
	}
}

uci_get() {
	local Result="$(uci get $1.@$2[0].$3)"
	[[ -n ${Result} ]] && echo "${Result}"
}

uci_set() {
	uci set $1.@$2[0].$3=$4
	uci commit $1
}

start() {
	bash ${Script} --clean > /dev/null 2>&1
	echo "Starting AutoUpdate service ..."
	AutoUpdate_Service
}

disable() {
	echo "Disable AutoUpdate service ..."
	uci_set autoupdate common enable 0
	uci_set autoupdate common force_write 0
	uci_set autoupdate common enable_proxy 0
	corn_rm
}